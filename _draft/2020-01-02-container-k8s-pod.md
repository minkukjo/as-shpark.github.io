---
title2: 파드
category: 쿠버네티스
order: 1
---

#### 1. 파드의 단계(phase) ####
- Pending: 파드가 승인되었지만 아직 이미지 생성이 완료되지 않은 단계
- Running: 파드의 모든 컨테이너가 생성되었고, 적어도 하나의 컨테이너가 동작 중이거나, 시작 또는 재시작 중에 있다.
- Succeeded: 모든 컨테이너들이 성공적으로 종료되었다.
- Failed: 모든 컨테이너들이 종료 되었지만, 하나 이상의 컨테이너가 exited or terminated 되었다.
- Unknown: 파드의 상태를 얻을 수 없다. 파드 호스트와의 통신 오류에 의해서 발생한다.

#### 2. 파드의 조건(condition) ####
- 파드의 각 단계에서 통과했거나 통과하지 못한 조건을 표시한다.
- lastProbTime: 마지막으로 조건이 조사된 시점
- lastTransitionTime: 파드가 한 상태에서 다른 상태로 전환된 마지막 시점
- message: 전환에 대한 사람이 읽을 수 있는 메시지
- reason: 전환의 이유
- status: true/false/unknown
- type: 
> PostScheduled: 파드가 하나의 노드로 스케쥴 완료되었음  
> Ready: 파드는 요청들을 수행할 수 있음  
> Initialized: 모든 초기화 컨테이너가 성공적으로 완료되었음  
> Unschedulable: 스케쥴러가 자원의 부족이나 다른 제약 등에 의해서 지금 당장은 파드를 스케쥴할 수 없음  
> ContainerReady: 파드 내의 모든 컨테이너가 준비 상태임

#### 3. 컨테이너 프로브 ####
- kubelet에 의해 주기적으로 수행되는 컨테이너 진단
- 진단을 위해 kubelet은 컨테이너에 의해 구현된 핸들러를 호출한다.
- 핸들러 타입:
> ExecAction: 컨테이너 내에서 지정된 명령을 실행한다. 명령어가 상태 코드 0으로 종료되면 성공한 것으로 간주  
> TcpSocketAction: 지정된 포트에서 컨테이너 IP 주소에 대해 TCP 검사를 수행한다. 포트가 활성화되어 있다면 성공한 것으로 간주한다.  
> HTTPGetAction: 지정된 포트에서 컨테이너 IP 주소에 대해 HTTP Get 요청을 수행한다. 응답 상태 코드가 200보다 크고 400보다 작으면 성공한 것으로 간주한다.
- Probe의 결과는 다음 중 하나의 값을 가진다. 
> Success: 진단 통과  
> Failure: 진단 실패  
> Unknown: 진단 자체가 실패
- 프로브의 종류 
> livenessProbe: 컨테이너가 동작 중인지 여부를 나타낸다. 활성 프로브에 실패한다면 kublet은 해당 컨테이너를 죽이고, 컨테이너는 재시작 정책의 대상이 된다.  
> readnessProbe: 컨테이너가 요청을 처리할 준비가 되었는지 여부를 나타낸다. 준비성 프로브가 실패한다면 엔드포인트 컨트롤러는 파드와 연관된 모든 서비스의 엔드포인트에서 파드의 IP 주소를 제거한다.  
> startupProbe: 컨테이너 내의 애플리케이션이 시작되었는지를 나타낸다. 스타트업 프로브가 주어진 경우, 성공할 때까지 다른 프로브는 활성화되지 않는다. 스타트업 프로브가 실패하면 kubelet은 컨테이너를 죽이고 컨테이너 재시작 정책에 따라 처리된다. 
- 언제 활성 프로브를 사용할까? 
> 프로브가 실패한 후 컨테이너가 종료되거나 재시작 되길 원한다면, 활성 프로브를 지정하고 restartPolicy를 Always 또는 OnFailure로 지정한다.
- 언제 준비성 프로브를 사용할까?
> 프로브가 성공한 경우에만 트래픽 전송을 시작하려고 할 때는 준비성 프로브를 지정한다. 컨테이너가 대량의 데이터, 설정 파일들, 시동 중 마이그레이션을 처리해야 한다면 준비성 프로브를 지정한다.
- 언제 스타트업 프로브를 사용할까?
> 컨테이너가 보통 initialDelaySeconds + failureThreshold + periodSeconds 이후에 기동된다면 스타트업 프로브가 활성화 프로브와 같은 엔드 포인트를 체크하도록 명시해야 한다.

#### 4. 파드의 상태와 컨테이너의 상태 ####
- 파드의 상태는 컨테이너의 상태에 의존적이다. 
- 컨테이너의 상태:
> Waiting: 컨테이너의 기본 상태, 이미지를 내려받거나 시크릿을 적용하는 등의 필요한 오퍼레이션이 수행 중인 상태이다.  
> Running: 이슈 없이 구동되는 상태, postStart 훅이 존재하면 Running 상태 이후에 실행된다.  
> Terminated: 컨테이너 실행이 완료되어 구동을 멈춘 상태, 작업을 완료했을 때나 실패했을 때 이 상태가 되며 preStop 훅이 존재한다면 이 상태가 되기 전에 실행된다.

#### 5. 파드의 재시작 정책 ####
- PodSpec은 Always, OnFailure, Never 과 같은 값으로 설정 가능한 restartPolicy 필드를 가지고 있다. 기본 값은 Always이다. 
- kubelet에 의해 재시작되는 종료된 컨테이너는 5분 제한된 지수-백-오프 지연(10초, 20초, 40초..)을 기준으로 재시작된다.

#### 6. 파드의 삭제 ####
- 파드는 일반적으로 명시적으로 삭제하기 전까지는 노드에 남아 있다.
- 컨트롤 플레인은 파드의 수가 설정된 임계치(terminated-pod-gc-threshold)를 초과할 때, 종료된 파드를 정리한다. 

#### 7. 파드에 역할에 따른 컨트롤러의 선택 ####
- Job: 
> 배치 연산과 같이 종료가 예상되는 파드일 경우 사용한다. 이 때, restartPolicy는 OnFailure 또는 Never 지정이 적합하다.
- 레플리케이션 컨트롤러, 레플리카 셋, 디플로이먼트: 
> 웹 서버와 같이 종료가 예상되지 않는 파드에 적합하다.  
> 레플리케이션 컨트롤러는 restartPolicy가 Always로 지정된 경우에만 적합하다.
- 데몬 셋:
> 머신 하나 당 실행해야 하는 파드를 위해서 적합하다. 데몬 셋은 특정 머신 전용 서비스를 제공하기 때문이다. 
- 파드를 직접적으로 생성하는 것보다 컨트롤러의 템플릿을 이용해 생성하는 것을 추천하는데, 그 이유는 머신의 실패에 대해서 컨트롤러는 탄력적으로 반응하기 때문이다. 만약 노드가 죽거나 다른 클러스터의 다른 노드들로부터 연결이 끊기면, 쿠버네티스는 잃어버린 노드에 있는 모든 파드의 phase를 Failed로 설정하는 정책을 적용한다. 


#### 8. 초기화 컨테이너 ####
- 파드의 앱 컨테이너가 실행되기 전에 먼저 실행되는 특수한 컨테이너이며, 앱의 이미지에는 없는 유틸리티 또는 설정 스크립트 등을 실행할 수 있다. 
- 하나의 파드에는 초기화 컨테이너를 여러 개 담을 수 있는데, 각 초기화 컨테이너는 다음 초기화 컨테이너가 실행되기 전에 성공적으로 완료되어야 한다.
- 초기화 컨테이너가 실패한다면, 쿠버네티스는 초기화 컨테이너가 성공할 때까지 파드를 반복적으로 재시작한다.
- 초기화 컨테이너들이 실패를 영원히 지속하는 상황을 방지하기 위해서 파드의 activeDeadlineSeconds와 컨테이너의 livenessProbe를 사용한다.


#### 9. 초기화 컨테이너의 이점 ####
- 앱 이미지에는 없는 셋업을 위한 유틸리티 또는 맞춤 코드를 포함할 수 있다. 예를 들어 셋업 중에 sed, awk, python, dig와 같은 도구를 사용하기 위해 다른 이미지로부터 새로운 이미지를 만들 필요가 없다. 
- 초기화 컨테이너는 앱 컨테이너와 다른 파일 시스템 뷰를 가지도록 Linux 네임스페이스를 사용한다. 결과적으로 초기화 컨테이너에는 앱 컨테이너가 가질 수 없는 시크릿에 접근 권한이 주어질 수 있다.
- 초기화 컨테이너들은 어떤 앱 컨테이너가 시작되기 전에 완료되어야 하므로, 앱 컨테이너가 실행되는 것을 막거나 지연시키는 간편한 방법을 제공한다.
```
예제1) 서비스가 생성될 때까지 기다리기

for i in {1..100}; do sleep 1; if dig myservice; then exit 0; fi; done; exit 1

예제2) 다운워드 API를 통해 원격 서버에 해당 파드 등록하기 
curl -X POST http://$MANAGEMENT_SERVICE_HOST:$MANAGEMENT_SERVICE_PORT/register -d 'instance=$(<POD_NAME>)&ip=$(<POD_IP>)'


예제3) 앱 컨테이너가 실행되기 전에 일정 시간 기다리기
sleep 60

예제4) Git 저장소를 볼륨 안에 clone 하기

예제5) 설정 파일에 값을 지정하고 메인 앱 컨테이너를 위한 설정 파일을 동적으로 생성하기 위한 템플릿 도구 실행하기 - 예를 들어, 설정에 POD_ID 값을 지정하고 메인 앱 설정 파일을 jinja를 통해서 생성

```

#### 10. 파드 실행시 초기화 컨테이너 재실행을 포함하는 경우 ####
- 초기화 컨테이너 변경을 하는 스펙 업데이트 
- 파드 인프라스트럭처 컨테이너 재시작 (노드에 대한 root 접근 권한자에 의해 발생)
- 파드의 restartPolicy가 Always인 상황에서 파드가 종료되었는데, 초기화 컨테이너의 완료 기록이 가비지 수집 때문에 유실된 경우


#### 11. 파드 토폴로지 분배 제약 조건 ####
- 토폴로지 분배 제약조건을 사용해 파드가 분산되는 방식을 결정할 수 있다. 

#### 12. 파드 프리셋 ####
- 파드 프리셋은 파드 생성 시간에 파드에 특정 정보를 주입하기 위한 오브젝트이다. 해당 정보에는 시크릿, 볼륨, 볼륨 마운트, 환경 변수가 포함될 수 있다. 
- 파드 프리셋을 사용하는 것은 파드 템플릿 작성자에게 모든 파드를 위한 모든 정보를 명시적으로 제공하지 않아도 되도록 한다.
- 어드미션 컨트롤러가 활성화 되면 파드 프리셋을 파드 생성 요청에 적용한다.

#### 13. 파드 프리셋의 동작 방식 ####
1) 사용 가능한 모든 파드 프리셋을 검색한다.
2) 파드 프리셋의 라벨 셀렉터가 파드의 라벨과 일치되는지 확인한다.
3) 파드 프리셋에 정의된 리소스가 생성되는 파드에 병합되도록 한다.
4) 오류 시, 병합 오류 이벤트를 발생시키고 파드 프리셋의 리소스는 제거한 채 파드를 생성한다.
5) 파드 스펙의 결과에 어노테이션을 달아서 파드 프리셋에 의해서 수정되었음을 표시한다. 

#### 14. Disruption Budgets ####
- 쿠버네티스는 자주 발생하는 자발적 중단에도 고가용성 애플리케이션을 실행할 수 있는 기능을 제공한다. 
- PDB(PodDisruptionBudget) 오브젝트는 자발적으로 일시에 중지되는 복제된 애플리케이션 파드의 수를 제한한다. 예를 들어 정족수 기반의 애플리케이션이 실행 중인 레플리카의 수가 정족수 이하로 떨어지지 않도록 한다.

#### 15. 임시 컨테이너 ####
- 재현하기 어려운 버그 문제를 해결하기 위해 파드의 상태를 점검하고 싶을 때, 기존 파드에서 임시 컨테이너를 실행해서 상태를 검사하고 임의의 명령을 내릴 수 있다.
- 임시 컨테이너는 실행에 대한 보증이 없고, 자동으로 재시작되지 않는다.
- 임시 컨테이너는 포트를 가지지 않을 수 있으므로, ports, livenessProbe, readinessProbe 와 같은 필드는 허용되지 않는다.
- 파드에 할당된 리소스는 변경할 수 없으므로, resource 설정이 허용되지 않는다. 

